<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深澜离线登录器 (AC_ID: 4)</title>
    <style>
        /* 界面样式 - 保持美观 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-card {
            background: #fff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 380px;
            border: 1px solid #eee;
        }
        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-header h2 { color: #333; font-weight: 700; margin-bottom: 5px; }
        .login-header p { color: #888; font-size: 0.9rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s;
        }
        .form-control:focus { border-color: #007bff; outline: none; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }
        .btn-login { background: #007bff; }
        .btn-login:hover { background: #0056b3; }
        .btn-logout { background: #dc3545; }
        .btn-logout:hover { background: #a71d2a; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        #status-area { margin-top: 20px; text-align: center; font-size: 13px; color: #666; min-height: 20px; }
        .status-success { color: green; font-weight: bold; }
        .status-error { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="login-card">
    <div class="login-header">
        <h2>校园网认证 (离线版)</h2>
        <p>无需外网 | AC_ID: 4</p>
    </div>
    <form id="loginForm">
        <div class="form-group">
            <input type="text" id="username" class="form-control" placeholder="学号" required>
        </div>
        <div class="form-group">
            <input type="password" id="password" class="form-control" placeholder="密码" required>
        </div>
        
        <div class="btn-group">
            <button type="submit" class="btn btn-login" id="loginBtn">登 录</button>
            <button type="button" class="btn btn-logout" id="logoutBtn">注 销</button>
        </div>
        
        <div id="status-area">准备就绪</div>
    </form>
</div>

<script>
    // ================= 配置区域 =================
    const CONFIG = {
        base_url: "http://10.145.255.21", 
        ac_id: "4",
        enc_ver: "srun_bx1",
        n: 200,
        type: 1
    };

    // ==========================================
    // 1. 极简加密库 (替代 CryptoJS，压缩体积)
    // ==========================================
    const MiniCrypto = {
        // MD5 实现
        md5: function(string) {
            function RotateLeft(lValue, iShiftBits) {
                return (lValue<<iShiftBits) | (lValue>>>(32-iShiftBits));
            }
            function AddUnsigned(lX,lY) {
                var lX4,lY4,lX8,lY8,lResult;
                lX8 = (lX & 0x80000000); lY8 = (lY & 0x80000000);
                lX4 = (lX & 0x40000000); lY4 = (lY & 0x40000000);
                lResult = (lX & 0x3FFFFFFF)+(lY & 0x3FFFFFFF);
                if (lX4 & lY4) { return (lResult ^ 0x80000000 ^ lX8 ^ lY8); }
                if (lX4 | lY4) { if (lResult & 0x40000000) return (lResult ^ 0xC0000000 ^ lX8 ^ lY8); else return (lResult ^ 0x40000000 ^ lX8 ^ lY8); }
                else { return (lResult ^ lX8 ^ lY8); }
            }
            function F(x,y,z) { return (x & y) | ((~x) & z); }
            function G(x,y,z) { return (x & z) | (y & (~z)); }
            function H(x,y,z) { return (x ^ y ^ z); }
            function I(x,y,z) { return (y ^ (x | (~z))); }
            function FF(a,b,c,d,x,s,ac) { a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac)); return AddUnsigned(RotateLeft(a, s), b); };
            function GG(a,b,c,d,x,s,ac) { a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac)); return AddUnsigned(RotateLeft(a, s), b); };
            function HH(a,b,c,d,x,s,ac) { a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac)); return AddUnsigned(RotateLeft(a, s), b); };
            function II(a,b,c,d,x,s,ac) { a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac)); return AddUnsigned(RotateLeft(a, s), b); };
            function ConvertToWordArray(string) {
                var lWordCount;
                var lMessageLength = string.length;
                var lNumberOfWords_temp1=lMessageLength + 8;
                var lNumberOfWords_temp2=(lNumberOfWords_temp1-(lNumberOfWords_temp1 % 64))/64;
                var lNumberOfWords = (lNumberOfWords_temp2+1)*16;
                var lWordArray=Array(lNumberOfWords-1);
                var lBytePosition = 0;
                var lByteCount = 0;
                while ( lByteCount < lMessageLength ) {
                    lWordCount = (lByteCount-(lByteCount % 4))/4;
                    lBytePosition = (lByteCount % 4)*8;
                    lWordArray[lWordCount] = (lWordArray[lWordCount] | (string.charCodeAt(lByteCount)<<lBytePosition));
                    lByteCount++;
                }
                lWordCount = (lByteCount-(lByteCount % 4))/4;
                lBytePosition = (lByteCount % 4)*8;
                lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80<<lBytePosition);
                lWordArray[lNumberOfWords-2] = lMessageLength<<3;
                lWordArray[lNumberOfWords-1] = lMessageLength>>>29;
                return lWordArray;
            };
            function WordToHex(lValue) {
                var WordToHexValue="",WordToHexValue_temp="",lByte,lCount;
                for (lCount = 0;lCount<=3;lCount++) {
                    lByte = (lValue>>>(lCount*8)) & 255;
                    WordToHexValue_temp = "0" + lByte.toString(16);
                    WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);
                }
                return WordToHexValue;
            };
            var x=ConvertToWordArray(string);
            var k,AA,BB,CC,DD,a,b,c,d;
            var S11=7, S12=12, S13=17, S14=22;
            var S21=5, S22=9 , S23=14, S24=20;
            var S31=4, S32=11, S33=16, S34=23;
            var S41=6, S42=10, S43=15, S44=21;
            a = 0x67452301; b = 0xEFCDAB89; c = 0x98BADCFE; d = 0x10325476;
            for (k=0;k<x.length;k+=16) {
                AA=a; BB=b; CC=c; DD=d;
                a=FF(a,b,c,d,x[k+0], S11,0xD76AA478); d=FF(d,a,b,c,x[k+1], S12,0xE8C7B756); c=FF(c,d,a,b,x[k+2], S13,0x242070DB); b=FF(b,c,d,a,x[k+3], S14,0xC1BDCEEE);
                a=FF(a,b,c,d,x[k+4], S11,0xF57C0FAF); d=FF(d,a,b,c,x[k+5], S12,0x4787C62A); c=FF(c,d,a,b,x[k+6], S13,0xA8304613); b=FF(b,c,d,a,x[k+7], S14,0xFD469501);
                a=FF(a,b,c,d,x[k+8], S11,0x698098D8); d=FF(d,a,b,c,x[k+9], S12,0x8B44F7AF); c=FF(c,d,a,b,x[k+10],S13,0xFFFF5BB1); b=FF(b,c,d,a,x[k+11],S14,0x895CD7BE);
                a=FF(a,b,c,d,x[k+12],S11,0x6B901122); d=FF(d,a,b,c,x[k+13],S12,0xFD987193); c=FF(c,d,a,b,x[k+14],S13,0xA679438E); b=FF(b,c,d,a,x[k+15],S14,0x49B40821);
                a=GG(a,b,c,d,x[k+1], S21,0xF61E2562); d=GG(d,a,b,c,x[k+6], S22,0xC040B340); c=GG(c,d,a,b,x[k+11],S23,0x265E5A51); b=GG(b,c,d,a,x[k+0], S24,0xE9B6C7AA);
                a=GG(a,b,c,d,x[k+5], S21,0xD62F105D); d=GG(d,a,b,c,x[k+10],S22,0x2441453); c=GG(c,d,a,b,x[k+15],S23,0xD8A1E681); b=GG(b,c,d,a,x[k+4], S24,0xE7D3FBC8);
                a=GG(a,b,c,d,x[k+9], S21,0x21E1CDE6); d=GG(d,a,b,c,x[k+14],S22,0xC33707D6); c=GG(c,d,a,b,x[k+3], S23,0xF4D50D87); b=GG(b,c,d,a,x[k+8], S24,0x455A14ED);
                a=GG(a,b,c,d,x[k+13],S21,0xA9E3E905); d=GG(d,a,b,c,x[k+2], S22,0xFCEFA3F8); c=GG(c,d,a,b,x[k+7], S23,0x676F02D9); b=GG(b,c,d,a,x[k+12],S24,0x8D2A4C8A);
                a=HH(a,b,c,d,x[k+5], S31,0xFFFA3942); d=HH(d,a,b,c,x[k+8], S32,0x8771F681); c=HH(c,d,a,b,x[k+11],S33,0x6D9D6122); b=HH(b,c,d,a,x[k+14],S34,0xFDE5380C);
                a=HH(a,b,c,d,x[k+1], S31,0xA4BEEA44); d=HH(d,a,b,c,x[k+4], S32,0x4BDECFA9); c=HH(c,d,a,b,x[k+7], S33,0xF6BB4B60); b=HH(b,c,d,a,x[k+10],S34,0xBEBFBC70);
                a=HH(a,b,c,d,x[k+13],S31,0x289B7EC6); d=HH(d,a,b,c,x[k+0], S32,0xEAA127FA); c=HH(c,d,a,b,x[k+3], S33,0xD4EF3085); b=HH(b,c,d,a,x[k+6], S34,0x4881D05);
                a=HH(a,b,c,d,x[k+9], S31,0xD9D4D039); d=HH(d,a,b,c,x[k+12],S32,0xE6DB99E5); c=HH(c,d,a,b,x[k+15],S33,0x1FA27CF8); b=HH(b,c,d,a,x[k+2], S34,0xC4AC5665);
                a=II(a,b,c,d,x[k+0], S41,0xF4292244); d=II(d,a,b,c,x[k+7], S42,0x432AFF97); c=II(c,d,a,b,x[k+14],S43,0xAB9423A7); b=II(b,c,d,a,x[k+5], S44,0xFC93A039);
                a=II(a,b,c,d,x[k+12],S41,0x655B59C3); d=II(d,a,b,c,x[k+3], S42,0x8F0CCC92); c=II(c,d,a,b,x[k+10],S43,0xFFEFF47D); b=II(b,c,d,a,x[k+1], S44,0x85845DD1);
                a=II(a,b,c,d,x[k+8], S41,0x6FA87E4F); d=II(d,a,b,c,x[k+15],S42,0xFE2CE6E0); c=II(c,d,a,b,x[k+6], S43,0xA3014314); b=II(b,c,d,a,x[k+13],S44,0x4E0811A1);
                a=II(a,b,c,d,x[k+4], S41,0xF7537E82); d=II(d,a,b,c,x[k+11],S42,0xBD3AF235); c=II(c,d,a,b,x[k+2], S43,0x2AD7D2BB); b=II(b,c,d,a,x[k+9], S44,0xEB86D391);
                a=AddUnsigned(a,AA); b=AddUnsigned(b,BB); c=AddUnsigned(c,CC); d=AddUnsigned(d,DD);
            }
            return (WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d)).toLowerCase();
        },
        // HMAC-MD5 实现
        hmac_md5: function(key, data) {
            var bkey = this.str2bin(key);
            if(bkey.length > 16) bkey = this.str2bin(this.md5(key));
            var ipad = Array(64), opad = Array(64);
            for(var i = 0; i < 64; i++){
                ipad[i] = bkey[i] ^ 0x36;
                opad[i] = bkey[i] ^ 0x5c;
            }
            var hash = this.md5(this.bin2str(ipad) + data);
            return this.md5(this.bin2str(opad) + hash);
        },
        str2bin: function(str) {
            var bin = Array();
            var mask = (1 << 8) - 1;
            for(var i = 0; i < str.length; i++) bin.push(str.charCodeAt(i) & mask);
            return bin;
        },
        bin2str: function(bin) {
            var str = "";
            for(var i = 0; i < bin.length; i++) str += String.fromCharCode(bin[i]);
            return str;
        },
        // SHA1 实现
        sha1: function(str) {
            var hexcase = 0; var b64pad  = ""; var chrsz   = 8;
            function hex_sha1(s){return binb2hex(core_sha1(str2binb(s),s.length * chrsz));}
            function core_sha1(x, len){
                x[len >> 5] |= 0x80 << (24 - len % 32); x[((len + 64 >> 9) << 4) + 15] = len;
                var w = Array(80); var a =  1732584193; var b = -271733879; var c = -1732584194; var d =  271733878; var e = -1009589776;
                for(var i = 0; i < x.length; i += 16){
                    var olda = a; var oldb = b; var oldc = c; var oldd = d; var olde = e;
                    for(var j = 0; j < 80; j++){
                        if(j < 16) w[j] = x[i + j]; else w[j] = rol(w[j-3] ^ w[j-8] ^ w[j-14] ^ w[j-16], 1);
                        var t = safe_add(safe_add(rol(a, 5), sha1_ft(j, b, c, d)), safe_add(safe_add(e, w[j]), sha1_kt(j)));
                        e = d; d = c; c = rol(b, 30); b = a; a = t;
                    }
                    a = safe_add(a, olda); b = safe_add(b, oldb); c = safe_add(c, oldc); d = safe_add(d, oldd); e = safe_add(e, olde);
                }
                return Array(a, b, c, d, e);
            }
            function sha1_ft(t, b, c, d){ if(t < 20) return (b & c) | ((~b) & d); if(t < 40) return b ^ c ^ d; if(t < 60) return (b & c) | (b & d) | (c & d); return b ^ c ^ d; }
            function sha1_kt(t){ return (t < 20) ?  1518500249 : (t < 40) ?  1859775393 : (t < 60) ? -1894007588 : -899497514; }
            function safe_add(x, y){ var lsw = (x & 0xFFFF) + (y & 0xFFFF); var msw = (x >> 16) + (y >> 16) + (lsw >> 16); return (msw << 16) | (lsw & 0xFFFF); }
            function rol(num, cnt){ return (num << cnt) | (num >>> (32 - cnt)); }
            function str2binb(str){ var bin = Array(); var mask = (1 << chrsz) - 1; for(var i = 0; i < str.length * chrsz; i += chrsz) bin[i>>5] |= (str.charCodeAt(i / chrsz) & mask) << (32 - chrsz - i%32); return bin; }
            function binb2hex(binarray){ var hex_tab = hexcase ? "0123456789ABCDEF" : "0123456789abcdef"; var str = ""; for(var i = 0; i < binarray.length * 4; i++){ str += hex_tab.charAt((binarray[i>>2] >> ((3 - i%4)*8+4)) & 0xF) + hex_tab.charAt((binarray[i>>2] >> ((3 - i%4)*8  )) & 0xF); } return str; }
            return hex_sha1(str);
        }
    };

    // ==========================================
    // 2. 原生 JSONP 实现 (替代 jQuery.ajax)
    // ==========================================
    function jsonp(url, params, callback) {
        // 生成唯一回调函数名 (模仿 jQuery 的格式)
        const callbackName = 'jQuery' + Date.now() + '_' + Math.floor(Math.random() * 100000);
        
        // 构造 Query String
        let queryString = [];
        for (let key in params) {
            if (params.hasOwnProperty(key)) {
                queryString.push(encodeURIComponent(key) + '=' + encodeURIComponent(params[key]));
            }
        }
        queryString.push('callback=' + callbackName);
        queryString.push('_=' + Date.now()); // 防缓存

        const scriptUrl = url + '?' + queryString.join('&');
        
        // 定义全局回调
        window[callbackName] = function(data) {
            callback(data);
            // 清理
            document.body.removeChild(script);
            delete window[callbackName];
        };

        // 插入 Script 标签
        const script = document.createElement('script');
        script.src = scriptUrl;
        script.onerror = function() {
            if(window[callbackName]) {
                // 如果出错但还没回调，手动触发错误
                // 这里简单处理，实际上 jsonp 很难捕获错误，只能超时
                alert('请求失败，请检查是否已连接校园网 WiFi/网线');
                document.body.removeChild(script);
                delete window[callbackName];
            }
        };
        document.body.appendChild(script);
    }

    // ==========================================
    // 3. 深澜算法 (适配 MiniCrypto)
    // ==========================================
    const SrunAlgo = {
        _base64Alpha: "LVoJPiCN2R8G90yg+hmFHuacZ1OWMnrsSTXkYpUq/3dlbfKwv6xztjI7DeBE45QA",
        xEncode: function(str, key) {
            if (str === "") return "";
            var v = this.s(str, true), k = this.s(key, false);
            if (k.length < 4) k.length = 4;
            var n = v.length - 1, z = v[n], y = v[0], c = 0x86014019 | 0x183639A0, m, e, p, q = Math.floor(6 + 52 / (n + 1)), d = 0;
            while (0 < q--) {
                d = d + c & (0x8CE0D9BF | 0x731F2640);
                e = d >>> 2 & 3;
                for (p = 0; p < n; p++) {
                    y = v[p + 1];
                    m = z >>> 5 ^ y << 2;
                    m += y >>> 3 ^ z << 4 ^ (d ^ y);
                    m += k[p & 3 ^ e] ^ z;
                    z = v[p] = v[p] + m & (0xEFB8D130 | 0x10472ECF);
                }
                y = v[0];
                m = z >>> 5 ^ y << 2;
                m += y >>> 3 ^ z << 4 ^ (d ^ y);
                m += k[p & 3 ^ e] ^ z;
                z = v[n] = v[n] + m & (0xBB390742 | 0x44C6F8BD);
            }
            return this.l(v, false);
        },
        s: function(a, b) {
            var c = a.length, v = [];
            for (var i = 0; i < c; i += 4) v[i >> 2] = a.charCodeAt(i) | a.charCodeAt(i + 1) << 8 | a.charCodeAt(i + 2) << 16 | a.charCodeAt(i + 3) << 24;
            if (b) v[v.length] = c;
            return v;
        },
        l: function(a, b) {
            var d = a.length, c = (d - 1) << 2;
            if (b) {
                var m = a[d - 1];
                if (m < c - 3 || m > c) return null;
                c = m;
            }
            for (var i = 0; i < d; i++) a[i] = String.fromCharCode(a[i] & 0xff, a[i] >>> 8 & 0xff, a[i] >>> 16 & 0xff, a[i] >>> 24 & 0xff);
            return b ? a.join('').substring(0, c) : a.join('');
        },
        base64Encode: function(str) {
            var out = "", i = 0, len = str.length, c1, c2, c3;
            while (i < len) {
                c1 = str.charCodeAt(i++) & 0xff;
                if (i == len) { out += this._base64Alpha.charAt(c1 >> 2); out += this._base64Alpha.charAt((c1 & 0x3) << 4); out += "=="; break; }
                c2 = str.charCodeAt(i++);
                if (i == len) { out += this._base64Alpha.charAt(c1 >> 2); out += this._base64Alpha.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4)); out += this._base64Alpha.charAt((c2 & 0xF) << 2); out += "="; break; }
                c3 = str.charCodeAt(i++);
                out += this._base64Alpha.charAt(c1 >> 2); out += this._base64Alpha.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4)); out += this._base64Alpha.charAt(((c2 & 0xF) << 2) | ((c3 & 0xC0) >> 6)); out += this._base64Alpha.charAt(c3 & 0x3F);
            }
            return out;
        },
        getEncryptedInfo: function(userInfoObj, token) {
            return "{SRBX1}" + this.base64Encode(this.xEncode(JSON.stringify(userInfoObj), token));
        }
    };

    // ==========================================
    // 4. 业务逻辑
    // ==========================================
    const $username = document.getElementById('username');
    const $password = document.getElementById('password');
    const $status = document.getElementById('status-area');
    const $loginBtn = document.getElementById('loginBtn');
    const $logoutBtn = document.getElementById('logoutBtn');

    function setStatus(msg, type) {
        $status.innerHTML = msg;
        $status.className = '';
        if(type === 'success') $status.className = 'status-success';
        if(type === 'error') $status.className = 'status-error';
    }

    function toggleBtns(enable) {
        $loginBtn.disabled = !enable;
        $logoutBtn.disabled = !enable;
    }

    // 登录事件
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const u = $username.value.trim();
        const p = $password.value.trim();
        if(!u || !p) return;

        toggleBtns(false);
        setStatus('正在握手...');

        // Step 1: Get Challenge
        jsonp(CONFIG.base_url + '/cgi-bin/get_challenge', { username: u, ip: '' }, function(res) {
            if(res.challenge) {
                setStatus('握手成功，认证中...');
                
                // 计算加密
                // 1. HMAC-MD5 (key=token, data=password) - 注意顺序，我的 MiniCrypto 实现是 hmac_md5(key, data)
                const hmd5 = MiniCrypto.hmac_md5(p, res.challenge); 
                
                // 2. Info 加密
                const infoObj = { username: u, password: p, ip: res.client_ip, acid: CONFIG.ac_id, enc_ver: CONFIG.enc_ver };
                const info = SrunAlgo.getEncryptedInfo(infoObj, res.challenge);

                // 3. Checksum SHA1
                const str = res.challenge + u + res.challenge + hmd5 + res.challenge + CONFIG.ac_id + res.challenge + res.client_ip + res.challenge + CONFIG.n + res.challenge + CONFIG.type + res.challenge + info;
                const chksum = MiniCrypto.sha1(str);

                // Step 2: Login
                const loginParams = {
                    action: 'login',
                    username: u,
                    password: '{MD5}' + hmd5,
                    ac_id: CONFIG.ac_id,
                    ip: res.client_ip,
                    chksum: chksum,
                    info: info,
                    n: CONFIG.n,
                    type: CONFIG.type,
                    os: 'Windows 10',
                    name: 'Windows',
                    double_stack: 0
                };

                jsonp(CONFIG.base_url + '/cgi-bin/srun_portal', loginParams, function(loginRes) {
                    toggleBtns(true);
                    if(loginRes.error === 'ok') {
                        setStatus('登录成功！', 'success');
                    } else {
                        setStatus('失败: ' + (loginRes.error_msg || loginRes.error), 'error');
                    }
                });

            } else {
                toggleBtns(true);
                setStatus('初始化失败: ' + (res.error), 'error');
            }
        });
    });

    // 注销事件
    $logoutBtn.addEventListener('click', function() {
        const u = $username.value.trim();
        if(!u) { setStatus('请填写学号', 'error'); return; }

        toggleBtns(false);
        setStatus('正在注销...');

        // Step 1: 先获取 IP
        jsonp(CONFIG.base_url + '/cgi-bin/get_challenge', { username: u, ip: '' }, function(res) {
            const client_ip = res.client_ip || '';
            
            // Step 2: 注销
            const logoutParams = {
                action: 'logout',
                username: u,
                ac_id: CONFIG.ac_id,
                ip: client_ip
            };

            jsonp(CONFIG.base_url + '/cgi-bin/srun_portal', logoutParams, function(outRes) {
                toggleBtns(true);
                if(outRes.error === 'ok') {
                    setStatus('已注销', 'success');
                } else {
                    setStatus('注销失败: ' + (outRes.error_msg || outRes.error), 'error');
                }
            });
        });
    });

</script>
</body>
</html>
